"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const Drive_1 = __importDefault(global[Symbol.for('ioc.use')]("Adonis/Core/Drive"));
const Application_1 = __importDefault(global[Symbol.for('ioc.use')]("Adonis/Core/Application"));
const Env_1 = __importDefault(global[Symbol.for('ioc.use')]("Adonis/Core/Env"));
const airtable_1 = __importDefault(require("airtable"));
const got_1 = __importDefault(require("got"));
const Solvers_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Solvers"));
const base = new airtable_1.default({ apiKey: Env_1.default.get('AIRTABLE_KEY') }).base(Env_1.default.get('AIRTABLE_BASE'));
const tableName = 'Days';
const useCache = true;
class DaysController {
    async index({ response, request }) {
        const year = request.qs().year;
        let params = year ? { filterByFormula: `yearName="${year}"` } : {};
        const records = await base(tableName).select(params).firstPage();
        return response.send(records);
    }
    async show({ params, response }) {
        const localPath = Application_1.default.tmpPath(`inputs/day-${params.id}.json`);
        let day;
        if (useCache) {
            try {
                const fileBuffer = await Drive_1.default.get(localPath);
                day = JSON.parse(fileBuffer.toString());
            }
            catch (e) {
                console.info('Day data not cached, file will be loaded from Airtable');
            }
        }
        if (!day) {
            try {
                day = await base(tableName).find(params.id);
                await Drive_1.default.put(localPath, JSON.stringify(day));
            }
            catch (e) {
                console.error(e);
            }
        }
        if (day) {
            if (day.fields.inputs && Array.isArray(day.fields.inputs)) {
                const dayName = day.fields.name ?? '';
                const inputs = day.fields.inputs.map(({ filename, url }) => ({
                    filename,
                    url,
                    isOgInput: filename === 'input.txt',
                }));
                const defaultInputData = inputs.find((input) => input.isOgInput);
                if (!defaultInputData) {
                    throw new Error(`No default input found for Day ${dayName}. ðŸ¤·`);
                }
                const input = await (0, got_1.default)(defaultInputData.url).text();
                const daySolvers = Solvers_1.default[`day${dayName.toString().padStart(2, '0')}`];
                if (typeof daySolvers === 'undefined') {
                    throw new Error(`No solvers found for Day ${day.fields.name}. ðŸ¤¨`);
                }
                const part1 = { answer: await daySolvers.solvePart1(input) };
                const part2 = { answer: await daySolvers.solvePart2(input) };
                return response.send({ day: dayName, part1, part2, ...day });
            }
            throw new Error(`No inputs found for Day ${day.fields.name}. ðŸ¤·`);
        }
        throw new Error(`Sorry, Day with id: ${params.id} doesn't exist. ðŸ˜”`);
    }
}
exports.default = DaysController;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRGF5c0NvbnRyb2xsZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJEYXlzQ29udHJvbGxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUNBLG9GQUEwQztBQUMxQyxnR0FBc0Q7QUFDdEQsZ0ZBQXNDO0FBQ3RDLHdEQUErQjtBQUMvQiw4Q0FBcUI7QUFDckIsZ0ZBQWlDO0FBRWpDLE1BQU0sSUFBSSxHQUFHLElBQUksa0JBQVEsQ0FBQyxFQUFFLE1BQU0sRUFBRSxhQUFHLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsYUFBRyxDQUFDLEdBQUcsQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFBO0FBQzdGLE1BQU0sU0FBUyxHQUFHLE1BQU0sQ0FBQTtBQUN4QixNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUE7QUFFckIsTUFBcUIsY0FBYztJQUMxQixLQUFLLENBQUMsS0FBSyxDQUFDLEVBQUUsUUFBUSxFQUFFLE9BQU8sRUFBdUI7UUFDM0QsTUFBTSxJQUFJLEdBQUcsT0FBTyxDQUFDLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQTtRQUM5QixJQUFJLE1BQU0sR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsZUFBZSxFQUFFLGFBQWEsSUFBSSxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFBO1FBR2xFLE1BQU0sT0FBTyxHQUFHLE1BQU0sSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxTQUFTLEVBQUUsQ0FBQTtRQUVoRSxPQUFPLFFBQVEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUE7SUFDL0IsQ0FBQztJQUVNLEtBQUssQ0FBQyxJQUFJLENBQUMsRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUF1QjtRQUd6RCxNQUFNLFNBQVMsR0FBRyxxQkFBVyxDQUFDLE9BQU8sQ0FBQyxjQUFjLE1BQU0sQ0FBQyxFQUFFLE9BQU8sQ0FBQyxD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QUFDLENBQUE7SUFDdkUsQ0FBQztDQUNGO0FBdEZELGlDQXNGQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEh0dHBDb250ZXh0Q29udHJhY3QgfSBmcm9tICdAaW9jOkFkb25pcy9Db3JlL0h0dHBDb250ZXh0J1xuaW1wb3J0IERyaXZlIGZyb20gJ0Bpb2M6QWRvbmlzL0NvcmUvRHJpdmUnXG5pbXBvcnQgQXBwbGljYXRpb24gZnJvbSAnQGlvYzpBZG9uaXMvQ29yZS9BcHBsaWNhdGlvbidcbmltcG9ydCBFbnYgZnJvbSAnQGlvYzpBZG9uaXMvQ29yZS9FbnYnXG5pbXBvcnQgQWlydGFibGUgZnJvbSAnYWlydGFibGUnXG5pbXBvcnQgZ290IGZyb20gJ2dvdCdcbmltcG9ydCBzb2x2ZXJzIGZyb20gJ0FwcC9Tb2x2ZXJzJ1xuXG5jb25zdCBiYXNlID0gbmV3IEFpcnRhYmxlKHsgYXBpS2V5OiBFbnYuZ2V0KCdBSVJUQUJMRV9LRVknKSB9KS5iYXNlKEVudi5nZXQoJ0FJUlRBQkxFX0JBU0UnKSlcbmNvbnN0IHRhYmxlTmFtZSA9ICdEYXlzJ1xuY29uc3QgdXNlQ2FjaGUgPSB0cnVlXG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIERheXNDb250cm9sbGVyIHtcbiAgcHVibGljIGFzeW5jIGluZGV4KHsgcmVzcG9uc2UsIHJlcXVlc3QgfTogSHR0cENvbnRleHRDb250cmFjdCkge1xuICAgIGNvbnN0IHllYXIgPSByZXF1ZXN0LnFzKCkueWVhclxuICAgIGxldCBwYXJhbXMgPSB5ZWFyID8geyBmaWx0ZXJCeUZvcm11bGE6IGB5ZWFyTmFtZT1cIiR7eWVhcn1cImAgfSA6IHt9XG5cbiAgICAvLyBQdWxsIERheXMgZGF0YSBmcm9tIEFpcnRhYmxlXG4gICAgY29uc3QgcmVjb3JkcyA9IGF3YWl0IGJhc2UodGFibGVOYW1lKS5zZWxlY3QocGFyYW1zKS5maXJzdFBhZ2UoKVxuXG4gICAgcmV0dXJuIHJlc3BvbnNlLnNlbmQocmVjb3JkcylcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBzaG93KHsgcGFyYW1zLCByZXNwb25zZSB9OiBIdHRwQ29udGV4dENvbnRyYWN0KSB7XG4gICAgLy8gVE9ETzogUmVhZCBjYWNoZWQgZGF5LCBpZiBub3QgZm91bmQsIGdldCBmcm9tIEFpcnRhYmxlIGFuZCB0aGVuIGNhY2hlIGl0XG5cbiAgICBjb25zdCBsb2NhbFBhdGggPSBBcHBsaWNhdGlvbi50bXBQYXRoKGBpbnB1dHMvZGF5LSR7cGFyYW1zLmlkfS5qc29uYClcbiAgICBsZXQgZGF5XG5cbiAgICBpZiAodXNlQ2FjaGUpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIC8vIEdldCBpbnB1dCBmcm9tIHRoZSBsb2NhbCBmaWxlIHN5c3RlbVxuICAgICAgICBjb25zdCBmaWxlQnVmZmVyID0gYXdhaXQgRHJpdmUuZ2V0KGxvY2FsUGF0aClcbiAgICAgICAgZGF5ID0gSlNPTi5wYXJzZShmaWxlQnVmZmVyLnRvU3RyaW5nKCkpXG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGNvbnNvbGUuaW5mbygnRGF5IGRhdGEgbm90IGNhY2hlZCwgZmlsZSB3aWxsIGJlIGxvYWRlZCBmcm9tIEFpcnRhYmxlJylcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoIWRheSkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgLy8gUHVsbCBEYXkgZGF0YSBmcm9tIEFpcnRhYmxlXG4gICAgICAgIGRheSA9IGF3YWl0IGJhc2UodGFibGVOYW1lKS5maW5kKHBhcmFtcy5pZClcbiAgICAgICAgYXdhaXQgRHJpdmUucHV0KGxvY2FsUGF0aCwgSlNPTi5zdHJpbmdpZnkoZGF5KSlcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihlKVxuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChkYXkpIHtcbiAgICAgIC8vIFRPRE86IExvb3AgdGhyb3VnaCB0aGUgcGFydHMsIGxvYWQgdGhlaXIgZGF0YSBhbmQgb25seSBzb2x2ZSBpZiB0aGVyZSBpcyBubyBhbnN3ZXJcblxuICAgICAgLy8gR2V0IGlucHV0IGZyb20gQWlydGFibGVcbiAgICAgIGlmIChkYXkuZmllbGRzLmlucHV0cyAmJiBBcnJheS5pc0FycmF5KGRheS5maWVsZHMuaW5wdXRzKSkge1xuICAgICAgICAvLyBpbnB1dEV4YW1wbGUgPSB7XG4gICAgICAgIC8vICAgXCJpZFwiOiBcImF0dFRnRFBPb25zcHR6RVlDXCIsXG4gICAgICAgIC8vICAgXCJ1cmxcIjogXCJodHRwczovL2RsLmFpcnRhYmxlLmNvbS8uYXR0YWNobWVudHMvNzE5ZmE2ZWI5Mjc4MDk3OWRiY2YwYTdhMGM1YzA0YTUvYTJjZWU3YTIvaW5wdXQudHh0XCIsXG4gICAgICAgIC8vICAgXCJmaWxlbmFtZVwiOiBcImlucHV0LnR4dFwiLFxuICAgICAgICAvLyAgIFwic2l6ZVwiOiA5MzExLFxuICAgICAgICAvLyAgIFwidHlwZVwiOiBcInRleHQvcGxhaW5cIlxuICAgICAgICAvLyB9XG4gICAgICAgIGNvbnN0IGRheU5hbWUgPSBkYXkuZmllbGRzLm5hbWUgPz8gKCcnIGFzIFN0cmluZylcblxuICAgICAgICBjb25zdCBpbnB1dHMgPSBkYXkuZmllbGRzLmlucHV0cy5tYXAoKHsgZmlsZW5hbWUsIHVybCB9KSA9PiAoe1xuICAgICAgICAgIGZpbGVuYW1lLFxuICAgICAgICAgIHVybCxcbiAgICAgICAgICBpc09nSW5wdXQ6IGZpbGVuYW1lID09PSAnaW5wdXQudHh0JyxcbiAgICAgICAgfSkpXG5cbiAgICAgICAgY29uc3QgZGVmYXVsdElucHV0RGF0YSA9IGlucHV0cy5maW5kKChpbnB1dCkgPT4gaW5wdXQuaXNPZ0lucHV0KVxuXG4gICAgICAgIC8vIE5vIGRlZmF1bHQgaW5wdXQgZm91bmRcbiAgICAgICAgaWYgKCFkZWZhdWx0SW5wdXREYXRhKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBObyBkZWZhdWx0IGlucHV0IGZvdW5kIGZvciBEYXkgJHtkYXlOYW1lfS4g8J+kt2ApXG4gICAgICAgIH1cblxuICAgICAgICAvLyBMb2FkIHRoZSBkZWZhdWx0IGlucHV0IHRleHQgZmlsZVxuICAgICAgICBjb25zdCBpbnB1dCA9IGF3YWl0IGdvdChkZWZhdWx0SW5wdXREYXRhLnVybCkudGV4dCgpXG5cbiAgICAgICAgLy8gU29sdmUgZWFjaCBwYXJ0XG4gICAgICAgIGNvbnN0IGRheVNvbHZlcnMgPSBzb2x2ZXJzW2BkYXkke2RheU5hbWUudG9TdHJpbmcoKS5wYWRTdGFydCgyLCAnMCcpfWBdXG5cbiAgICAgICAgLy8gVGhyb3cgZXJyb3IgaWYgbm8gc29sdmVyIGlzIGZvdW5kXG4gICAgICAgIGlmICh0eXBlb2YgZGF5U29sdmVycyA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE5vIHNvbHZlcnMgZm91bmQgZm9yIERheSAke2RheS5maWVsZHMubmFtZX0uIPCfpKhgKVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcGFydDEgPSB7IGFuc3dlcjogYXdhaXQgZGF5U29sdmVycy5zb2x2ZVBhcnQxKGlucHV0KSB9XG4gICAgICAgIGNvbnN0IHBhcnQyID0geyBhbnN3ZXI6IGF3YWl0IGRheVNvbHZlcnMuc29sdmVQYXJ0MihpbnB1dCkgfVxuXG4gICAgICAgIHJldHVybiByZXNwb25zZS5zZW5kKHsgZGF5OiBkYXlOYW1lLCBwYXJ0MSwgcGFydDIsIC4uLmRheSB9KVxuICAgICAgfVxuXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYE5vIGlucHV0cyBmb3VuZCBmb3IgRGF5ICR7ZGF5LmZpZWxkcy5uYW1lfS4g8J+kt2ApXG4gICAgfVxuXG4gICAgdGhyb3cgbmV3IEVycm9yKGBTb3JyeSwgRGF5IHdpdGggaWQ6ICR7cGFyYW1zLmlkfSBkb2Vzbid0IGV4aXN0LiDwn5iUYClcbiAgfVxufVxuIl19