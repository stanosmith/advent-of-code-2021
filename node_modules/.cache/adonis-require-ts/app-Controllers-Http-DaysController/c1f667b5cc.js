"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const Drive_1 = __importDefault(global[Symbol.for('ioc.use')]("Adonis/Core/Drive"));
const Application_1 = __importDefault(global[Symbol.for('ioc.use')]("Adonis/Core/Application"));
const Env_1 = __importDefault(global[Symbol.for('ioc.use')]("Adonis/Core/Env"));
const airtable_1 = __importDefault(require("airtable"));
const got_1 = __importDefault(require("got"));
const Solvers_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Solvers"));
const base = new airtable_1.default({ apiKey: Env_1.default.get('AIRTABLE_KEY') }).base(Env_1.default.get('AIRTABLE_BASE'));
const tableName = 'Days';
const useCache = false;
class DaysController {
    async index({ response, params, request }) {
        const urlQueries = request.qs();
        const { yearName } = params;
        const records = await base(tableName)
            .select({ filterByFormula: `yearName="${yearName}"` })
            .firstPage();
        return response.send({ urlQueries, totalRecords: records.length, records });
    }
    async show({ params, response }) {
        const { yearName, name } = params;
        let localPath = Application_1.default.tmpPath(`inputs/day-${yearName}-${name.padStart(2, '0')}.json`);
        let day;
        if (useCache) {
            try {
                const fileBuffer = await Drive_1.default.get(localPath);
                day = JSON.parse(fileBuffer.toString());
            }
            catch (e) {
                console.info('Day data not cached, file will be loaded from Airtable');
            }
        }
        if (!day) {
            try {
                const page = await base(tableName)
                    .select({
                    filterByFormula: `AND(name="${name}",yearName="${yearName}")`,
                })
                    .firstPage();
                day = page[0];
            }
            catch (e) {
                console.error(e);
            }
        }
        if (day) {
            await Drive_1.default.put(localPath, JSON.stringify(day));
            if (day.fields.inputs && Array.isArray(day.fields.inputs)) {
                const dayName = day.fields.name ?? '';
                const inputs = day.fields.inputs.map(({ filename, url }) => ({
                    filename,
                    url,
                    isOgInput: filename === 'input.txt',
                }));
                const defaultInputData = inputs.find((input) => input.isOgInput);
                if (!defaultInputData) {
                    throw new Error(`No default input found for Day ${dayName}. ðŸ¤·`);
                }
                const input = await (0, got_1.default)(defaultInputData.url).text();
                const daySolvers = Solvers_1.default[`day${dayName.toString().padStart(2, '0')}`];
                let part1 = {};
                let part2 = {};
                if (typeof daySolvers !== 'undefined') {
                    part1 = { answer: await daySolvers.solvePart1(input) };
                    part2 = { answer: await daySolvers.solvePart2(input) };
                }
                return response.send({ part1, part2, ...day });
            }
            throw new Error(`No inputs found for Day ${day.fields.name}. ðŸ¤·`);
        }
        return response.safeStatus(404).send(`Sorry, no data found for ${name}/${yearName}. ðŸ˜”`);
    }
}
exports.default = DaysController;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRGF5c0NvbnRyb2xsZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJEYXlzQ29udHJvbGxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUNBLG9GQUEwQztBQUMxQyxnR0FBc0Q7QUFDdEQsZ0ZBQXNDO0FBQ3RDLHdEQUErQjtBQUMvQiw4Q0FBcUI7QUFDckIsZ0ZBQWlDO0FBRWpDLE1BQU0sSUFBSSxHQUFHLElBQUksa0JBQVEsQ0FBQyxFQUFFLE1BQU0sRUFBRSxhQUFHLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsYUFBRyxDQUFDLEdBQUcsQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFBO0FBQzdGLE1BQU0sU0FBUyxHQUFHLE1BQU0sQ0FBQTtBQUN4QixNQUFNLFFBQVEsR0FBRyxLQUFLLENBQUE7QUFFdEIsTUFBcUIsY0FBYztJQUMxQixLQUFLLENBQUMsS0FBSyxDQUFDLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQXVCO1FBQ25FLE1BQU0sVUFBVSxHQUFHLE9BQU8sQ0FBQyxFQUFFLEVBQUUsQ0FBQTtRQUMvQixNQUFNLEVBQUUsUUFBUSxFQUFFLEdBQUcsTUFBTSxDQUFBO1FBRzNCLE1BQU0sT0FBTyxHQUFHLE1BQU0sSUFBSSxDQUFDLFNBQVMsQ0FBQzthQUNsQyxNQUFNLENBQUMsRUFBRSxlQUFlLEVBQUUsYUFBYSxRQUFRLEdBQUcsRUFBRSxDQUFDO2FBQ3JELFNBQVMsRUFBRSxDQUFBO1FBRWQsT0FBTyxRQUFRLENBQUMsSUFBSSxDQUFDLEVBQUUsVUFBVSxFQUFFLFlBQVksRUFBRSxPQUFPLENBQUMsTUFBTSxFQUFFLE9BQU8sRUFBRSxDQUFDLENBQUE7SUFDN0UsQ0FBQztJQUVNLEtBQUssQ0FBQyxJQUFJLENBQUMsRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUF1QjtRQUV6RCxNQUFNLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxHQUFHLE1BQU0sQ0FBQTtR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LEdBQUcsRUFBRSxDQUFDLENBQUE7YUFDL0M7WUFFRCxNQUFNLElBQUksS0FBSyxDQUFDLDJCQUEyQixHQUFHLENBQUMsTUFBTSxDQUFDLElBQUksTUFBTSxDQUFDLENBQUE7U0FDbEU7UUFFRCxPQUFPLFFBQVEsQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLDRCQUE0QixJQUFJLElBQUksUUFBUSxNQUFNLENBQUMsQ0FBQTtJQUMxRixDQUFDO0NBQ0Y7QUFsR0QsaUNBa0dDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSHR0cENvbnRleHRDb250cmFjdCB9IGZyb20gJ0Bpb2M6QWRvbmlzL0NvcmUvSHR0cENvbnRleHQnXG5pbXBvcnQgRHJpdmUgZnJvbSAnQGlvYzpBZG9uaXMvQ29yZS9Ecml2ZSdcbmltcG9ydCBBcHBsaWNhdGlvbiBmcm9tICdAaW9jOkFkb25pcy9Db3JlL0FwcGxpY2F0aW9uJ1xuaW1wb3J0IEVudiBmcm9tICdAaW9jOkFkb25pcy9Db3JlL0VudidcbmltcG9ydCBBaXJ0YWJsZSBmcm9tICdhaXJ0YWJsZSdcbmltcG9ydCBnb3QgZnJvbSAnZ290J1xuaW1wb3J0IHNvbHZlcnMgZnJvbSAnQXBwL1NvbHZlcnMnXG5cbmNvbnN0IGJhc2UgPSBuZXcgQWlydGFibGUoeyBhcGlLZXk6IEVudi5nZXQoJ0FJUlRBQkxFX0tFWScpIH0pLmJhc2UoRW52LmdldCgnQUlSVEFCTEVfQkFTRScpKVxuY29uc3QgdGFibGVOYW1lID0gJ0RheXMnXG5jb25zdCB1c2VDYWNoZSA9IGZhbHNlXG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIERheXNDb250cm9sbGVyIHtcbiAgcHVibGljIGFzeW5jIGluZGV4KHsgcmVzcG9uc2UsIHBhcmFtcywgcmVxdWVzdCB9OiBIdHRwQ29udGV4dENvbnRyYWN0KSB7XG4gICAgY29uc3QgdXJsUXVlcmllcyA9IHJlcXVlc3QucXMoKVxuICAgIGNvbnN0IHsgeWVhck5hbWUgfSA9IHBhcmFtc1xuXG4gICAgLy8gUHVsbCBEYXlzIGRhdGEgZnJvbSBBaXJ0YWJsZVxuICAgIGNvbnN0IHJlY29yZHMgPSBhd2FpdCBiYXNlKHRhYmxlTmFtZSlcbiAgICAgIC5zZWxlY3QoeyBmaWx0ZXJCeUZvcm11bGE6IGB5ZWFyTmFtZT1cIiR7eWVhck5hbWV9XCJgIH0pXG4gICAgICAuZmlyc3RQYWdlKClcblxuICAgIHJldHVybiByZXNwb25zZS5zZW5kKHsgdXJsUXVlcmllcywgdG90YWxSZWNvcmRzOiByZWNvcmRzLmxlbmd0aCwgcmVjb3JkcyB9KVxuICB9XG5cbiAgcHVibGljIGFzeW5jIHNob3coeyBwYXJhbXMsIHJlc3BvbnNlIH06IEh0dHBDb250ZXh0Q29udHJhY3QpIHtcbiAgICAvLyBHZXQgY2FjaGVkIGRheSwgaWYgbm90IGZvdW5kLCBnZXQgZnJvbSBBaXJ0YWJsZSBhbmQgdGhlbiBjYWNoZSBpdFxuICAgIGNvbnN0IHsgeWVhck5hbWUsIG5hbWUgfSA9IHBhcmFtc1xuICAgIGxldCBsb2NhbFBhdGggPSBBcHBsaWNhdGlvbi50bXBQYXRoKGBpbnB1dHMvZGF5LSR7eWVhck5hbWV9LSR7bmFtZS5wYWRTdGFydCgyLCAnMCcpfS5qc29uYClcbiAgICBsZXQgZGF5XG5cbiAgICBpZiAodXNlQ2FjaGUpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIC8vIEdldCBkYXkgZGF0YSBmcm9tIHRoZSBsb2NhbCBmaWxlIHN5c3RlbVxuICAgICAgICBjb25zdCBmaWxlQnVmZmVyID0gYXdhaXQgRHJpdmUuZ2V0KGxvY2FsUGF0aClcbiAgICAgICAgZGF5ID0gSlNPTi5wYXJzZShmaWxlQnVmZmVyLnRvU3RyaW5nKCkpXG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGNvbnNvbGUuaW5mbygnRGF5IGRhdGEgbm90IGNhY2hlZCwgZmlsZSB3aWxsIGJlIGxvYWRlZCBmcm9tIEFpcnRhYmxlJylcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoIWRheSkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgLy8gUHVsbCBEYXkgZGF0YSBmcm9tIEFpcnRhYmxlXG4gICAgICAgIGNvbnN0IHBhZ2UgPSBhd2FpdCBiYXNlKHRhYmxlTmFtZSlcbiAgICAgICAgICAuc2VsZWN0KHtcbiAgICAgICAgICAgIGZpbHRlckJ5Rm9ybXVsYTogYEFORChuYW1lPVwiJHtuYW1lfVwiLHllYXJOYW1lPVwiJHt5ZWFyTmFtZX1cIilgLFxuICAgICAgICAgIH0pXG4gICAgICAgICAgLmZpcnN0UGFnZSgpXG5cbiAgICAgICAgLy8gVGhlcmUgc2hvdWxkIG9ubHkgYmUgb25lIGl0ZW0gaW4gdGhlIGFycmF5XG4gICAgICAgIGRheSA9IHBhZ2VbMF1cbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihlKVxuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChkYXkpIHtcbiAgICAgIC8vIENhY2hlIHRoZSBkYXkgZGF0YVxuICAgICAgYXdhaXQgRHJpdmUucHV0KGxvY2FsUGF0aCwgSlNPTi5zdHJpbmdpZnkoZGF5KSlcblxuICAgICAgLy8gVE9ETzogTG9vcCB0aHJvdWdoIHRoZSBwYXJ0cywgbG9hZCB0aGVpciBkYXRhIGFuZCBvbmx5IHNvbHZlIGlmIHRoZXJlIGlzIG5vIGFuc3dlclxuXG4gICAgICAvLyBHZXQgaW5wdXQgZnJvbSBBaXJ0YWJsZVxuICAgICAgaWYgKGRheS5maWVsZHMuaW5wdXRzICYmIEFycmF5LmlzQXJyYXkoZGF5LmZpZWxkcy5pbnB1dHMpKSB7XG4gICAgICAgIC8vIGlucHV0RXhhbXBsZSA9IHtcbiAgICAgICAgLy8gICBcImlkXCI6IFwiYXR0VGdEUE9vbnNwdHpFWUNcIixcbiAgICAgICAgLy8gICBcInVybFwiOiBcImh0dHBzOi8vZGwuYWlydGFibGUuY29tLy5hdHRhY2htZW50cy83MTlmYTZlYjkyNzgwOTc5ZGJjZjBhN2EwYzVjMDRhNS9hMmNlZTdhMi9pbnB1dC50eHRcIixcbiAgICAgICAgLy8gICBcImZpbGVuYW1lXCI6IFwiaW5wdXQudHh0XCIsXG4gICAgICAgIC8vICAgXCJzaXplXCI6IDkzMTEsXG4gICAgICAgIC8vICAgXCJ0eXBlXCI6IFwidGV4dC9wbGFpblwiXG4gICAgICAgIC8vIH1cbiAgICAgICAgY29uc3QgZGF5TmFtZSA9IGRheS5maWVsZHMubmFtZSA/PyAoJycgYXMgU3RyaW5nKVxuXG4gICAgICAgIGNvbnN0IGlucHV0cyA9IGRheS5maWVsZHMuaW5wdXRzLm1hcCgoeyBmaWxlbmFtZSwgdXJsIH0pID0+ICh7XG4gICAgICAgICAgZmlsZW5hbWUsXG4gICAgICAgICAgdXJsLFxuICAgICAgICAgIGlzT2dJbnB1dDogZmlsZW5hbWUgPT09ICdpbnB1dC50eHQnLFxuICAgICAgICB9KSlcblxuICAgICAgICBjb25zdCBkZWZhdWx0SW5wdXREYXRhID0gaW5wdXRzLmZpbmQoKGlucHV0KSA9PiBpbnB1dC5pc09nSW5wdXQpXG5cbiAgICAgICAgLy8gTm8gZGVmYXVsdCBpbnB1dCBmb3VuZFxuICAgICAgICBpZiAoIWRlZmF1bHRJbnB1dERhdGEpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE5vIGRlZmF1bHQgaW5wdXQgZm91bmQgZm9yIERheSAke2RheU5hbWV9LiDwn6S3YClcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIExvYWQgdGhlIGRlZmF1bHQgaW5wdXQgdGV4dCBmaWxlXG4gICAgICAgIGNvbnN0IGlucHV0ID0gYXdhaXQgZ290KGRlZmF1bHRJbnB1dERhdGEudXJsKS50ZXh0KClcblxuICAgICAgICAvLyBTb2x2ZSBlYWNoIHBhcnRcbiAgICAgICAgY29uc3QgZGF5U29sdmVycyA9IHNvbHZlcnNbYGRheSR7ZGF5TmFtZS50b1N0cmluZygpLnBhZFN0YXJ0KDIsICcwJyl9YF1cblxuICAgICAgICBsZXQgcGFydDEgPSB7fVxuICAgICAgICBsZXQgcGFydDIgPSB7fVxuXG4gICAgICAgIC8vIElmIHdlIGhhdmUgc29sdmVycywgc29sdmUgZWFjaCBwYXJ0XG4gICAgICAgIGlmICh0eXBlb2YgZGF5U29sdmVycyAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICBwYXJ0MSA9IHsgYW5zd2VyOiBhd2FpdCBkYXlTb2x2ZXJzLnNvbHZlUGFydDEoaW5wdXQpIH1cbiAgICAgICAgICBwYXJ0MiA9IHsgYW5zd2VyOiBhd2FpdCBkYXlTb2x2ZXJzLnNvbHZlUGFydDIoaW5wdXQpIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZXNwb25zZS5zZW5kKHsgcGFydDEsIHBhcnQyLCAuLi5kYXkgfSlcbiAgICAgIH1cblxuICAgICAgdGhyb3cgbmV3IEVycm9yKGBObyBpbnB1dHMgZm91bmQgZm9yIERheSAke2RheS5maWVsZHMubmFtZX0uIPCfpLdgKVxuICAgIH1cblxuICAgIHJldHVybiByZXNwb25zZS5zYWZlU3RhdHVzKDQwNCkuc2VuZChgU29ycnksIG5vIGRhdGEgZm91bmQgZm9yICR7bmFtZX0vJHt5ZWFyTmFtZX0uIPCfmJRgKVxuICB9XG59XG4iXX0=